# Continous Integration setup for SU2.
# Tests on the develop and master branch in both serial and parallel.
language: cpp

compiler:
    - g++

env:
    # Serial build and test
    - CONFIGURE_COMMAND=$SERIAL
    # Parallel build and test 
    - CONFIGURE_COMMAND=$PARALLEL

notifications:
    email:
        - padronas@stanford.edu
  
branches:
    only:
        - feature_TravisCI

before_install:
    - sudo apt-get update -qq
    - sudo apt-get install -qq python-numpy mpich2
    - export SERIAL = './configure --prefix=/usr/local CXXFLAGS="-O3"'
    - export PARALLEL = './configure --enable-mpi --with-cc=`which mpicc` --with-cxx=`which mpicxx` --prefix=/usr/local CXXFLAGS="-O3"'
    - echo $CONFIGURE_COMMAND

install:
    # Think test matrix compiling code in serial and parallel.
    - $CONFIGURE_COMMAND
    # Add environmental variables according to the configure step
    - export SU2_RUN="/usr/local/bin"
    # Find out what SU2_HOME is used for.
    - export SU2_HOME="/home/travis/build/su2code/SU2"
    - export PATH=$PATH:$SU2_RUN
    - export PYTHONPATH=$PYTHONPATH:$SU2_RUN
    - make -j 8
    - sudo make install

before_script:
    - git clone https://github.com/su2code/TestCases.git
    - cd TestCases/
    - git checkout feature_TravisCI

# run test
script:
    - if [ $CONFIGURE_COMMAND == $SERIAL ]; then python serial_regression.py; fi
    - if [ $CONFIGURE_COMMAND == $PARALLEL ]; then python parallel_regression.py; fi


